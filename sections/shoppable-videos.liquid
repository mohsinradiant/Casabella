<link rel="stylesheet" href="{{ 'shoppable_videos.css' | asset_url }}">
<div class="shoppable_videos-container">
  <div class="page-width">
    <div class="shoppable_videos-relative">
      <p class="section-caption">{{ section.settings.section_caption }}</p>
      <p class="section-heading">{{ section.settings.section_heading }}</p>
      <div class="shoppable_videos-wrapper">
        {% for block in section.blocks %}
          <div class="shoppable_videos-item">
            {{
              block.settings.video
              | video_tag: autoplay: true, loop: true, muted: true, controls: false, playsinline: true
            }}
            {% render 'card-product',
              card_product: block.settings.product,
              media_aspect_ratio: 'sqaure',
              quick_add: 'standard'
            %}
          </div>
        {% endfor %}
      </div>

      <!-- arrows -->
      <button class="scroller-arrow left shoppable-scroller-arrow" aria-label="Previous">
        <img
          src="https://cdn.shopify.com/s/files/1/0752/2510/4562/files/Group_433.png?v=1770214279"
        >
      </button>
      <button class="scroller-arrow right shoppable-scroller-arrow" aria-label="Next">
        <img
          src="https://cdn.shopify.com/s/files/1/0752/2510/4562/files/Group_433.png?v=1770214279"
          style="transform: rotate(180deg);"
        >
      </button>
    </div>
  </div>

  <!-- dots -->
  <div class="categories-dots shoppable_videos-dots">
    <div class="shoppable_videos-dots-track"></div>
  </div>
  <a href="{{ section.settings.section_cta_link }}" class="shoppable-videos-cta">
    {{ section.settings.section_cta }}
  </a>

  <div class="shoppable_videos-absolute-container">
    <img
      src="https://cdn.shopify.com/s/files/1/0752/2510/4562/files/Group_454_2.png?v=1770898580"
      class="shoppable_videos-container-top-image_strip"
    >
    <img
      class="shoppable_videos-container-bottom-image_strip"
      src="https://cdn.shopify.com/s/files/1/0752/2510/4562/files/Group_455.png?v=1769756289"
    >
    <img
      class="shoppable_videos-container-bottom-image_rotating"
      src="https://cdn.shopify.com/s/files/1/0752/2510/4562/files/Mask_group.png?v=1769756308"
    >
    <img
      class="shoppable_videos-container-bottom-image_flower"
      src="https://cdn.shopify.com/s/files/1/0752/2510/4562/files/dfsf_13.png?v=1769756309"
    >
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.shoppable_videos-container').forEach((container) => {
      const scroller = container.querySelector('.shoppable_videos-wrapper');
      const dotsTrack = container.querySelector('.shoppable_videos-dots-track');
      const prevBtn = container.querySelector('.shoppable-scroller-arrow.left');
      const nextBtn = container.querySelector('.shoppable-scroller-arrow.right');

      if (!scroller || !dotsTrack) return;

      let items = [...scroller.children];
      if (!items.length) return;

      let itemsPerSlide = 3;
      let itemGap = 20; /* match CSS gap */
      let itemWidth = items[0].offsetWidth;
      let slideWidth = (itemWidth + itemGap) * itemsPerSlide;
      let totalSlides = Math.max(1, Math.ceil(items.length / itemsPerSlide));
      let currentSlide = 0;

      function buildDots() {
        dotsTrack.innerHTML = '';
        for (let i = 0; i < totalSlides; i++) {
          const dot = document.createElement('button');
          if (i === 0) dot.classList.add('active');
          dot.addEventListener('click', () => goToSlide(i));
          dotsTrack.appendChild(dot);
        }
      }

      function goToSlide(index, smooth = true) {
        currentSlide = Math.max(0, Math.min(index, totalSlides - 1));
        scroller.scrollTo({ left: slideWidth * currentSlide, behavior: smooth ? 'smooth' : 'auto' });
        updateDots();
      }

      function updateDots() {
        const dots = [...dotsTrack.children];
        dots.forEach((dot, i) => {
          dot.classList.remove('active', 'prev', 'next');
          if (i === currentSlide) dot.classList.add('active');
          if (i === currentSlide - 1) dot.classList.add('prev');
          if (i === currentSlide + 1) dot.classList.add('next');
        });

        if (dots[0]) {
          const dotWidth = dots[0].offsetWidth + 8;
          const offset = dotsTrack.parentElement.offsetWidth / 2 - dotWidth / 2;
          dotsTrack.style.transform = `translateX(${offset - currentSlide * dotWidth}px)`;
        }
      }

      function recalc() {
        items = [...scroller.children];
        itemWidth = items[0] ? items[0].offsetWidth : 0;

        // responsive items per slide based on container width
        const cw = container.offsetWidth;
        if (cw <= 749) itemsPerSlide = 1;
        else if (cw <= 1023) itemsPerSlide = 2;
        else itemsPerSlide = 3;

        slideWidth = (itemWidth + itemGap) * itemsPerSlide;
        totalSlides = Math.max(1, Math.ceil(items.length / itemsPerSlide));
        if (currentSlide >= totalSlides) currentSlide = totalSlides - 1;
        buildDots();
        goToSlide(currentSlide, false);
      }

      nextBtn && nextBtn.addEventListener('click', () => goToSlide(currentSlide + 1));
      prevBtn && prevBtn.addEventListener('click', () => goToSlide(currentSlide - 1));

      if (window.ResizeObserver) {
        new ResizeObserver(recalc).observe(container);
      } else {
        window.addEventListener('resize', recalc);
      }

      // initialize
      recalc();
    });
  });
</script>
{% schema %}
{
  "name": "Shoppable Videos",
  "settings": [
    {
      "type": "text",
      "id": "section_caption",
      "label": "Section Caption"
    },
    {
      "type": "text",
      "id": "section_heading",
      "label": "Section Heading"
    },
    {
      "type": "text",
      "id": "section_cta",
      "label": "Section CTA"
    },
    {
      "type": "url",
      "id": "section_cta_link",
      "label": "Section CTA Link"
    }
  ],
  "blocks": [
    {
      "type": "shoppable_video",
      "name": "Shoppable Video",
      "settings": [
        {
          "type": "video",
          "id": "video",
          "label": "Block Video"
        },
        {
          "type": "product",
          "id": "product",
          "label": "Block Product"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Shoppable Videos"
    }
  ]
}
{% endschema %}
