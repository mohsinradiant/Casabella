<link rel="stylesheet" href="{{ 'categories.css' | asset_url }}">
<div class="categories-scroller-container">
  <div class="page-width">
    <h2 class="categories-scroller-title">{{ section.settings.section_title }}</h2>
    <div class="categories-scroller-relative">
      <div class="categories-scroller-wrapper" id="categoriesScroller">
        {% for block in section.blocks %}
          <a
            href="{{ block.settings.collection.url }}"
            class="category-item"
            {{ block.shopify_attributes }}
          >
            {% if block.settings.image %}
              <img
                src="{{ block.settings.image | img_url: '300x300' }}"
                alt="{{ block.settings.text }}"
              >
            {% endif %}
            <p class="category-name">{{ block.settings.text }}</p>
          </a>
        {% endfor %}
      </div>
      <!-- arrows -->
      <button class="scroller-arrow left" aria-label="Previous">
        <img src="https://cdn.shopify.com/s/files/1/0752/2510/4562/files/Group_433.png?v=1770214279">
      </button>
      <button class="scroller-arrow right" aria-label="Next">
        <img
          src="https://cdn.shopify.com/s/files/1/0752/2510/4562/files/Group_433.png?v=1770214279"
          style="transform: rotate(180deg);"
        >
      </button>
    </div>
  </div>
  <!-- dots -->
  <div class="categories-dots">
    <div class="categories-dots-track" id="categoriesDots"></div>
  </div>
  <a href="{{ section.settings.cta_link }}" class="categories-scroller-cta">{{ section.settings.cta }}</a>
  <div class="categories-scroller-container-bottom">
    <img
      class="categories-scroller-container-bottom-image_strip"
      src="https://cdn.shopify.com/s/files/1/0752/2510/4562/files/Group_455.png?v=1769756289"
    >
    <img
      class="categories-scroller-container-bottom-image_rotating"
      src="https://cdn.shopify.com/s/files/1/0752/2510/4562/files/Mask_group.png?v=1769756308"
    >
    <img
      class="categories-scroller-container-bottom-image_flower"
      src="https://cdn.shopify.com/s/files/1/0752/2510/4562/files/dfsf_13.png?v=1769756309"
    >
  </div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const scroller = document.getElementById('categoriesScroller');
    const dotsTrack = document.getElementById('categoriesDots');
    const prevBtn = document.querySelector('.scroller-arrow.left');
    const nextBtn = document.querySelector('.scroller-arrow.right');

    const items = [...scroller.children];
    if (!items.length) return;

    // variables that can change when the viewport/resizing occurs
    let slideWidth;
    let totalSlides;
    let currentSlide = 0;
    let dots = [];
    let autoScrollInterval; // declared early for use in resize listener

    function calculateMetrics() {
      slideWidth = scroller.clientWidth;
      totalSlides = Math.ceil(scroller.scrollWidth / slideWidth);
    }

    function createDots() {
      dotsTrack.innerHTML = '';
      for (let i = 0; i < totalSlides; i++) {
        const dot = document.createElement('button');
        if (i === currentSlide) dot.classList.add('active');
        dot.addEventListener('click', () => goToSlide(i));
        dotsTrack.appendChild(dot);
      }
      dots = [...dotsTrack.children];
    }

    calculateMetrics();
    createDots();

    // some images may still be loading when DOMContentLoaded fires; re-run on full load
    window.addEventListener('load', () => {
      const prev = totalSlides;
      calculateMetrics();
      if (totalSlides !== prev) {
        createDots();
        updateDots();
      }
    });

    function goToSlide(index) {
      currentSlide = Math.max(0, Math.min(index, totalSlides - 1));

      scroller.scrollTo({
        left: slideWidth * currentSlide,
        behavior: 'smooth',
      });

      updateDots();
    }

    function updateDots() {
      dots.forEach((dot, i) => {
        dot.classList.remove('active', 'prev', 'next');
        if (i === currentSlide) dot.classList.add('active');
        if (i === currentSlide - 1) dot.classList.add('prev');
        if (i === currentSlide + 1) dot.classList.add('next');
      });

      /* center active dot */
      const dotWidth = dots[0].offsetWidth + 8;
      const offset = dotsTrack.parentElement.offsetWidth / 2 - dotWidth / 2;
      dotsTrack.style.transform = `translateX(${offset - currentSlide * dotWidth}px)`;
    }

    // recalc on resize and recreate dots if needed
    window.addEventListener('resize', () => {
      const previousTotal = totalSlides;
      calculateMetrics();
      if (totalSlides !== previousTotal) {
        // ensure currentSlide remains in bounds
        currentSlide = Math.min(currentSlide, totalSlides - 1);
        createDots();
        updateDots();
      }
      // restart auto-scroll interval so it stays consistent
      clearInterval(autoScrollInterval);
      autoScrollInterval = setInterval(() => {
        let next = currentSlide + 1;
        if (next >= totalSlides) next = 0;
        goToSlide(next);
      }, 3000);
    });

    nextBtn.addEventListener('click', () => goToSlide(currentSlide + 1));
    prevBtn.addEventListener('click', () => goToSlide(currentSlide - 1));

    // auto-scroll every 3 seconds and loop back to start for infinite carousel
    autoScrollInterval = setInterval(() => {
      let next = currentSlide + 1;
      if (next >= totalSlides) next = 0;
      goToSlide(next);
    }, 3000);

    // optionally pause on hover
    scroller.addEventListener('mouseenter', () => clearInterval(autoScrollInterval));
    scroller.addEventListener('mouseleave', () => {
      autoScrollInterval = setInterval(() => {
        let next = currentSlide + 1;
        if (next >= totalSlides) next = 0;
        goToSlide(next);
      }, 3000);
    });

    updateDots();
  });
</script>
{% schema %}
{
  "name": "Categories Scroller",
  "settings": [
    {
      "type": "text",
      "id": "section_title",
      "label": "Section Title",
      "default": "Explore Categories"
    },
    {
      "type": "text",
      "id": "cta",
      "label": "CTA",
      "default": "VIEW ALL CATEGORIES"
    },
    {
      "type": "url",
      "label": "CTA Link",
      "id": "cta_link"
    }
  ],
  "blocks": [
    {
      "type": "category",
      "name": "Category",
      "settings": [
        {
          "type": "collection",
          "id": "collection",
          "label": "Collection Link"
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Category Image"
        },
        {
          "type": "text",
          "id": "text",
          "label": "Category Name"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Categories Scroller"
    }
  ]
}
{% endschema %}
